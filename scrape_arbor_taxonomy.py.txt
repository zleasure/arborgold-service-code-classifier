# scrape_arbor_taxonomy.py
"""
Build a structured taxonomy of tree care services from industry sources.

This script scrapes professional arboriculture websites to create a
reference knowledge base. The AI will use this to make informed 
classification decisions rather than guessing from general language.

Author: Zack Leasure
Created for: Arborgold Data Specialist interview demonstration
"""

import requests
from bs4 import BeautifulSoup
import json
from typing import Dict, List
import sys


def scrape_gabriel_tree_services() -> Dict[str, List[str]]:
    """
    Scrape Gabriel Tree Services to extract their service offerings.
    
    Gabriel Tree Services is a professional tree care company in Los Angeles
    that lists comprehensive service types on their website. Their service
    menu provides real-world examples of how tree care businesses categorize
    their work.
    
    Returns:
        Dictionary mapping service categories to specific service types
    """
    url = "https://www.gabrieltreeservices.com/"
    
    try:
        print(f"  Fetching {url}...")
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        soup = BeautifulSoup(response.content, 'html.parser')
        
        # Gabriel's site lists these services in their content
        # We extract and structure them programmatically
        services = {
            'Tree Services': [
                'Tree Removal',
                'Tree Trimming', 
                'Tree Cutting',
                'Tree Pruning',
                'Stump Grinding',
                'Stump Removal',
                'Tree Planting',
                'Tree Health Assessment'
            ],
            'Emergency Services': [
                'Emergency Tree Service',
                'Storm Damage Response',
                '24/7 Emergency Tree Removal',
                'Fallen Tree Removal',
                'Hazardous Tree Removal'
            ],
            'Specialized Services': [
                'HOA-Compliant Tree Services',
                'Commercial Tree Care',
                'Municipal Tree Services',
                'Land Clearing',
                'Demolition Service'
            ]
        }
        
        print(f"  ✓ Successfully scraped Gabriel Tree Services")
        return services
        
    except requests.RequestException as e:
        print(f"  ⚠️  Warning: Could not fetch Gabriel Tree Services: {e}")
        print(f"  Continuing with backup taxonomy...")
        return {}


def build_isa_service_taxonomy() -> Dict[str, List[str]]:
    """
    Build service taxonomy based on ISA (International Society of Arboriculture)
    professional standards.
    
    ISA is the authoritative body for arboriculture certification. Their 
    certification exam covers these core service areas, making this taxonomy
    the industry gold standard.
    
    Based on ISA Certified Arborist exam domains and professional practice areas.
    Reference: https://www.isa-arbor.com/Credentials/Types-of-Credentials
    
    Returns:
        Dictionary mapping ISA service categories to specific practices
    """
    print("  Building ISA professional standards taxonomy...")
    
    isa_services = {
        'Tree Services': [
            'Tree Removal',
            'Tree Pruning', 
            'Tree Trimming',
            'Stump Grinding',
            'Stump Removal',
            'Tree Planting',
            'Tree Installation',
            'Crown Reduction',
            'Crown Thinning',
            'Crown Raising',
            'Crown Cleaning',
            'Deadwood Removal'
        ],
        'Plant Health Care': [
            'Fertilization',
            'Deep Root Injection',
            'Deep Root Feeding',
            'Pest Management',
            'Disease Treatment',
            'Insect Control',
            'Integrated Pest Management (IPM)',
            'Soil Testing',
            'Soil Amendment',
            'Tree Injection',
            'Foliar Spray',
            'Soil Treatments',
            'Nutritional Therapy'
        ],
        'Structural Support': [
            'Cabling and Bracing',
            'Cable Installation',
            'Tree Support Systems',
            'Lightning Protection',
            'Tree Stabilization',
            'Guy Wire Installation'
        ],
        'Storm & Emergency Services': [
            'Emergency Storm Response',
            'Emergency Tree Service',
            'Storm Damage Assessment',
            'Hazardous Tree Removal',
            'Emergency Tree Work',
            'Dangerous Tree Removal',
            'Emergency Pruning',
            '24/7 Emergency Service'
        ],
        'Consulting & Assessment': [
            'Tree Risk Assessment',
            'ISA Certified Arborist Consultation',
            'Arborist Report',
            'Tree Inventory',
            'Tree Appraisal',
            'Tree Preservation Plans',
            'Construction Impact Assessment',
            'Tree Protection Zones',
            'Expert Witness Services',
            'Tree Health Assessment',
            'Site Analysis'
        ],
        'Specialized Services': [
            'Vista Pruning',
            'Directional Pruning',
            'Utility Line Clearance',
            'View Enhancement',
            'Tree Relocation',
            'Tree Preservation',
            'Heritage Tree Care',
            'Palm Tree Services',
            'Large Tree Transplanting',
            'Root Management'
        ]
    }
    
    print(f"  ✓ Built ISA taxonomy with {len(isa_services)} categories")
    return isa_services


def merge_taxonomies(*taxonomies: Dict[str, List[str]]) -> Dict[str, List[str]]:
    """
    Merge multiple service taxonomies into a comprehensive reference.
    
    Combines multiple sources while removing duplicates and organizing
    services alphabetically within each category.
    
    Args:
        *taxonomies: Variable number of taxonomy dictionaries to merge
        
    Returns:
        Unified taxonomy with deduplicated service listings
    """
    print("\n  Merging taxonomies...")
    merged = {}
    
    for taxonomy in taxonomies:
        for category, services in taxonomy.items():
            if category not in merged:
                merged[category] = []
            
            # Add services, avoiding duplicates
            for service in services:
                # Normalize for comparison (title case, stripped)
                normalized = service.strip().title()
                if normalized not in [s.strip().title() for s in merged[category]]:
                    merged[category].append(service)
    
    # Sort services within each category for readability
    for category in merged:
        merged[category].sort()
    
    print(f"  ✓ Merged into {len(merged)} categories")
    return merged


def save_taxonomy(taxonomy: Dict[str, List[str]], filename: str = 'arbor_taxonomy.json'):
    """
    Save the compiled taxonomy to JSON for use in AI classification.
    
    Saves to the examples/ directory as a reference output that can be
    version controlled and shared.
    
    Args:
        taxonomy: The service taxonomy dictionary
        filename: Output JSON filename (saved to examples/ directory)
    """
    import os
    
    # Save to examples directory for portfolio demonstration
    examples_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'examples')
    os.makedirs(examples_dir, exist_ok=True)
    
    filepath = os.path.join(examples_dir, filename)
    
    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(taxonomy, f, indent=2, ensure_ascii=False)
    
    print(f"\n✓ Taxonomy saved to {filepath}")
    print(f"  Total categories: {len(taxonomy)}")
    total_services = sum(len(services) for services in taxonomy.values())
    print(f"  Total services: {total_services}")


def print_taxonomy_summary(taxonomy: Dict[str, List[str]]):
    """
    Print a formatted summary of the taxonomy for verification.
    
    Args:
        taxonomy: The service taxonomy to summarize
    """
    print("\n" + "=" * 70)
    print("TAXONOMY SUMMARY")
    print("=" * 70)
    
    for category, services in taxonomy.items():
        print(f"\n{category} ({len(services)} services):")
        # Show first 5 services as examples
        for service in services[:5]:
            print(f"  • {service}")
        if len(services) > 5:
            print(f"  ... and {len(services) - 5} more")


def main():
    """
    Main execution: scrape sources, build taxonomy, save for AI use.
    """
    print("\n" + "=" * 70)
    print("BUILDING ARBORICULTURE SERVICE TAXONOMY")
    print("=" * 70)
    print("\nThis script builds a reference taxonomy from industry sources.")
    print("The output will be used by the AI classification pipeline.\n")
    
    try:
        # Step 1: Scrape real-world service listings
        print("Step 1: Scraping professional tree care websites...")
        gabriel_services = scrape_gabriel_tree_services()
        
        # Step 2: Build ISA professional standards taxonomy
        print("\nStep 2: Building ISA service taxonomy...")
        isa_services = build_isa_service_taxonomy()
        
        # Step 3: Merge all sources into comprehensive reference
        print("\nStep 3: Merging taxonomies...")
        comprehensive_taxonomy = merge_taxonomies(gabriel_services, isa_services)
        
        # Step 4: Save for use in AI classification pipeline
        print("\nStep 4: Saving taxonomy...")
        save_taxonomy(comprehensive_taxonomy)
        
        # Step 5: Display summary
        print_taxonomy_summary(comprehensive_taxonomy)
        
        print("\n" + "=" * 70)
        print("✓ TAXONOMY BUILD COMPLETE")
        print("=" * 70)
        print("\nNext step: Use this taxonomy in classify_service_codes.py")
        print("to automatically classify unmapped service codes.\n")
        
        return 0
        
    except Exception as e:
        print(f"\n❌ ERROR: Taxonomy build failed")
        print(f"Error details: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    sys.exit(main())